---
# Develpy tests, from root folder run: ./testme.sh.

- name: Apply python developer configuration.
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
  - name: Test with non-empty user mary.
    debug:
      msg:
        - '__________________________________________________________________'
        - 'Testing with non-empty user mary ...'
        - '        __....._'
        - '     .`` _  o    ``'
        - '   ." O (_)     () o`'
        - '  .           O        '
        - ' . ()   o__...__    O   '
        - '. _.--```       ```--._ '
        - ':`                     `'
        - ' `-.__    :    :   __.-`'
        - '      ```-:    :-```'
        - '         J     '
        - '         :     '
        - '        J       '
        - '        :       '
        - '        `._____.'
        - '__________________________________________________________________'

  - name: Apply configuration using user mary.
    include_role:
      name: constrict0r.develpy
    vars:
      users: [mary]

  - name: Verify curl installed.
    file:
      path: /usr/bin/curl

  - name: Verify emacs installed.
    file:
      path: /usr/bin/emacs

  - name: Verify direnv installed.
    file:
      path: /usr/bin/direnv

  - name: Verify flake8 installed.
    command: python3 -m pip list --format=columns | grep flake8
    register: flake8_result
    become: true
    failed_when: flake8_result.stdout is not search('flake8') 

  - name: Verify direnv configured for user mary.
    command: cat /home/mary/.bashrc
    register: bashrc_result
    failed_when: bashrc_result.stdout is not search('direnv')

  - name: Verify emacs main configuration file created for mary.
    file:
      path: /home/mary/.emacs.d/init.el
    become: true

  - name: Verify emacs python configuration file created for user mary.
    file:
      path: /home/mary/.emacs.d/config/python.el
    become: true

  - name: Verify emacs theme downloaded for mary.
    file:
      path:  /home/mary/.emacs.d/themes/wintermute-theme.el

  - name: Verify poetry configured for user mary.
    command: cat /home/mary/.profile
    register: profile_result
    become: true
    failed_when: profile_result.stdout is not search('poetry')
